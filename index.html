<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LOGBOOK — Missing (N hari) dengan Pagination & Tanggal dd-MM-yyyy</title>

  <!-- ===== CSS ASLI (TIDAK DIUBAH) ===== -->
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; margin:0; padding:20px; }
    .wrap { max-width:1100px; margin:0 auto; background:#fff; padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .controls { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; align-items:center; }
    input[type=text], input[type=number], select, button { padding:8px; border:1px solid #ccc; border-radius:6px; }
    button { cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border:1px solid #e2e8f0; text-align:left; font-size:14px; }
    th { background:#0ea5b6; color:white; }
    .panel { margin-top:18px; padding:12px; border-radius:8px; background:#fafafa; border:1px solid #eee; }
    .flexrow { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .small { font-size:13px; color:#666; }
    .pagination { margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pagination button { padding:6px 10px; }
    .nowrap { white-space:nowrap; }
    @media (max-width:700px){ .controls { flex-direction:column; align-items:stretch; } }
  </style>

  <!-- ===== SheetJS (Excel Export) ===== -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body>
<div class="wrap">
  <h1>LOGBOOK — Cek Driver yang Belum Mengisi (N hari terakhir)</h1>

  <!-- FILTER -->
  <div class="controls">
    <input id="filterCabang" placeholder="Filter cabang (kosong = semua)">
    <input id="filterPlat" placeholder="Filter plat (BM 1234 AB)">
    <select id="missingCabangFilter" style="min-width:200px;">
      <option value="">Semua cabang</option>
    </select>
    <button id="btnRefresh">Refresh / Apply</button>
    <span class="small">Data berasal dari Apps Script API</span>
  </div>

  <!-- PANEL MISSING -->
  <div class="panel">
    <h3>Cek driver yang belum mengisi (N hari terakhir)</h3>
    <div class="flexrow">
      N hari:
      <input id="missingDaysCount" type="number" min="1" value="7" style="width:90px;">
      <button id="btnMissingLastNDays">Tampilkan Missing</button>
      <button id="btnMissingLastNDaysTable">Tulis ke Tabel</button>
      <button id="btnDownloadMissingLastNDaysExcel">Download Excel</button>

      <label class="small">
        <input id="excludeSundays2" type="checkbox">
        Exclude Sundays
      </label>
    </div>
  </div>

  <div id="status" class="small" style="margin-top:12px">Memuat...</div>

  <!-- TABLE -->
  <div style="overflow:auto">
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  <div id="paginationControls" class="pagination" style="display:none">
    <button id="btnPrevPage">Prev</button>
    <span class="small nowrap">
      Halaman <input id="inputPage" type="number" value="1" style="width:60px">
      dari <span id="spanTotalPages">1</span>
    </span>
    <button id="btnNextPage">Next</button>
    <span class="small"> / <span id="spanPageSize">50</span> baris</span>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxD3EsjEJ3X5PiEjDwor_YljpqUWUmYObHRKgavtUJ5TOqs4eaITa2XatvSTxtSlbXE/exec";
const API_KEY = "KEY-2025";

/* ================= STATE ================= */
let rawRows = [];
let currentKeys = [];
let currentPage = 1;
const pageSize = 50;
document.getElementById('spanPageSize').textContent = pageSize;

/* ================= FETCH ================= */
async function fetchApi(params={}) {
  params.apiKey = API_KEY;
  const res = await fetch(API_URL + "?" + new URLSearchParams(params));
  return await res.json();
}

/* ================= LOAD ================= */
async function loadAll() {
  status.textContent = 'Memuat...';
  const cab = filterCabang.value.trim();
  const plat = filterPlat.value.trim();

  let res;
  if (cab) res = await fetchApi({action:'getByCabang', cabang:cab});
  else if (plat) res = await fetchApi({action:'getByPlat', plat});
  else res = await fetchApi({action:'getAll'});

  rawRows = res.data || [];
  currentKeys = rawRows[0] ? Object.keys(rawRows[0]) : [];
  currentPage = 1;
  renderTable();
  status.textContent = `Selesai. ${rawRows.length} baris.`;
}

/* ================= RENDER ================= */
function renderTable(){
  thead.innerHTML = tbody.innerHTML = '';
  if(!rawRows.length){
    thead.innerHTML = '<tr><th>Tidak ada data</th></tr>';
    return;
  }

  thead.innerHTML =
    '<tr>' + currentKeys.map(k=>`<th>${k}</th>`).join('') + '</tr>';

  const start = (currentPage-1)*pageSize;
  rawRows.slice(start, start+pageSize).forEach(r=>{
    tbody.insertAdjacentHTML('beforeend',
      '<tr>' + currentKeys.map(k=>`<td>${r[k]??''}</td>`).join('') + '</tr>'
    );
  });

  paginationControls.style.display =
    rawRows.length > pageSize ? 'flex':'none';

  spanTotalPages.textContent = Math.ceil(rawRows.length/pageSize);
  inputPage.value = currentPage;
}

/* ================= MISSING ================= */
btnMissingLastNDays.onclick = async ()=>{
  const n = Number(missingDaysCount.value)||7;
  const res = await fetchApi({
    action:'missingLastNDays',
    n,
    excludeSundays: excludeSundays2.checked?'true':'false'
  });

  const per = res.result?.perDriverMissingDays || {};
  rawRows = Object.keys(per).map(d=>({
    Driver:d,
    'Total Missing':per[d].length,
    'Missing Days':per[d].join(', ')
  }));
  currentKeys = ['Driver','Total Missing','Missing Days'];
  currentPage = 1;
  renderTable();
};

/* ================= EXCEL (GANTI CSV) ================= */
btnDownloadMissingLastNDaysExcel.onclick = ()=>{
  if(!rawRows.length) return alert('Tidak ada data');
  const ws = XLSX.utils.json_to_sheet(rawRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Missing");
  XLSX.writeFile(
    wb,
    `missing_last_${missingDaysCount.value}_days.xlsx`
  );
};

/* ================= EVENTS ================= */
btnRefresh.onclick = loadAll;
btnPrevPage.onclick = ()=>{if(currentPage>1){currentPage--;renderTable();}};
btnNextPage.onclick = ()=>{currentPage++;renderTable();};
inputPage.onchange = ()=>{currentPage=Number(inputPage.value)||1;renderTable();};

/* ================= INIT ================= */
loadAll();
</script>
</body>
</html>
