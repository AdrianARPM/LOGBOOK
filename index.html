<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LOGBOOK — Missing (N hari) dengan Pagination & Tanggal dd-MM-yyyy</title>

  <!-- ADD: Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; margin:0; padding:20px; }
    .wrap { max-width:1100px; margin:0 auto; background:#fff; padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .controls { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; align-items:center; }
    input[type=text], input[type=number], select, button { padding:8px; border:1px solid #ccc; border-radius:6px; }
    button { cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border:1px solid #e2e8f0; text-align:left; font-size:14px; }
    th { background:#0ea5b6; color:white; }
    .panel { margin-top:18px; padding:12px; border-radius:8px; background:#fafafa; border:1px solid #eee; }
    .flexrow { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .small { font-size:13px; color:#666; }
    .pagination { margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pagination button { padding:6px 10px; }
    .nowrap { white-space:nowrap; }

    /* ADD: badge */
    .badge{padding:3px 10px;border-radius:999px;font-size:12px;font-weight:600}
    .badge-ok{background:#dcfce7;color:#166534}
    .badge-warn{background:#fef3c7;color:#92400e}
    .badge-danger{background:#fee2e2;color:#991b1b}

    @media (max-width:700px){ .controls { flex-direction:column; align-items:stretch; } }
  </style>
</head>
<body>
<div class="wrap">
  <h1>LOGBOOK — Cek Driver yang Belum Mengisi (N hari terakhir)</h1>

  <div class="controls">
    <input id="filterCabang" placeholder="Filter cabang (kosong = semua)">
    <input id="filterPlat" placeholder="Filter plat (BM 1234 AB)">
    <label style="display:flex; gap:8px; align-items:center;">
      <span class="small">Pilih Cabang (hasil missing):</span>
      <select id="missingCabangFilter" style="min-width:200px;">
        <option value="">Semua cabang</option>
      </select>
    </label>
    <button id="btnRefresh">Refresh / Apply</button>
  </div>

  <div class="panel">
    <h3>Cek driver yang belum mengisi (N hari terakhir)</h3>
    <div class="flexrow">
      N hari:
      <input id="missingDaysCount" type="number" min="1" value="7" style="width:80px;">
      <button id="btnMissingLastNDays">Tampilkan</button>
      <button id="btnMissingLastNDaysTable">Tulis ke tabel</button>
      <button id="btnDownloadMissingLastNDaysCSV">CSV</button>
      <button id="btnDownloadMissingLastNDaysExcel">Excel</button>
      <label>
        <input id="excludeSundays2" type="checkbox"> Exclude Sunday
      </label>
    </div>
  </div>

  <div id="status" class="small"></div>

  <table id="tbl">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="paginationControls" class="pagination" style="display:none">
    <button id="btnPrevPage">Prev</button>
    <span>Page <input id="inputPage" type="number" min="1" value="1" style="width:60px"> /
      <span id="spanTotalPages">1</span></span>
    <button id="btnNextPage">Next</button>
    <span><span id="spanPageSize">50</span> rows</span>
  </div>

  <div class="panel" id="missingResults" style="display:none;">
    <h3>Hasil Missing</h3>
    <div id="missingSummary" class="small"></div>
    <div id="missingContent"></div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxD3EsjEJ3X5PiEjDwor_YljpqUWUmYObHRKgavtUJ5TOqs4eaITa2XatvSTxtSlbXE/exec";
const API_KEY = "KEY-2025";

let rawRows = [];
let currentKeys = [];
let currentPage = 1;
const pageSize = 50;
document.getElementById('spanPageSize').textContent = pageSize;

function jsonpFetch(url){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=(d)=>{delete window[cb];s.remove();res(d)};
    const s=document.createElement("script");
    s.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
    s.onerror=rej;
    document.head.appendChild(s);
  });
}

async function fetchApi(p){
  p.apiKey=API_KEY;
  const u=API_URL+"?"+new URLSearchParams(p);
  try{
    const r=await fetch(u);
    if(!r.ok) throw 0;
    return await r.json();
  }catch{
    return await jsonpFetch(u);
  }
}

function renderBadge(n){
  n=Number(n)||0;
  if(n===0) return `<span class="badge badge-ok">0</span>`;
  if(n<=3) return `<span class="badge badge-warn">${n}</span>`;
  return `<span class="badge badge-danger">${n}</span>`;
}

function renderRawTablePaged(){
  const thead=document.getElementById("thead");
  const tbody=document.getElementById("tbody");
  thead.innerHTML=""; tbody.innerHTML="";
  if(!rawRows.length) return;

  if(!currentKeys.length) currentKeys=Object.keys(rawRows[0]);

  const trh=document.createElement("tr");
  currentKeys.forEach(k=>{const th=document.createElement("th");th.textContent=k;trh.appendChild(th)});
  thead.appendChild(trh);

  const start=(currentPage-1)*pageSize;
  rawRows.slice(start,start+pageSize).forEach(r=>{
    const tr=document.createElement("tr");
    currentKeys.forEach(k=>{
      const td=document.createElement("td");
      if(k==="Total Missing") td.innerHTML=renderBadge(r[k]);
      else td.textContent=r[k]??"";
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  const totalPages=Math.ceil(rawRows.length/pageSize);
  document.getElementById("paginationControls").style.display=totalPages>1?"flex":"none";
  document.getElementById("spanTotalPages").textContent=totalPages;
  document.getElementById("inputPage").value=currentPage;
}

async function loadAll(){
  const res=await fetchApi({action:"getAll"});
  rawRows=res.data||[];
  currentKeys=[];
  currentPage=1;
  renderRawTablePaged();
}

async function fetchMissing(n){
  return await fetchApi({
    action:"missingLastNDays",
    n:String(n),
    excludeSundays:document.getElementById("excludeSundays2").checked?"true":"false"
  });
}

function downloadExcel(n,res){
  const per=res.result.perDriverMissingDays||{};
  const rows=[["Driver","Total Missing","Missing Days"]];
  Object.keys(per).forEach(d=>{
    rows.push([d,per[d].length,per[d].join(", ")]);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Missing");
  XLSX.writeFile(wb,"missing_"+n+"_days.xlsx");
}

document.getElementById("btnRefresh").onclick=loadAll;

document.getElementById("btnMissingLastNDaysTable").onclick=async()=>{
  const n=+missingDaysCount.value||7;
  const r=await fetchMissing(n);
  rawRows=Object.keys(r.result.perDriverMissingDays||{}).map(d=>({
    Driver:d,
    "Missing Days":r.result.perDriverMissingDays[d].join(", "),
    "Total Missing":r.result.perDriverMissingDays[d].length
  }));
  currentKeys=["Driver","Missing Days","Total Missing"];
  currentPage=1;
  renderRawTablePaged();
};

document.getElementById("btnDownloadMissingLastNDaysExcel").onclick=async()=>{
  const n=+missingDaysCount.value||7;
  const r=await fetchMissing(n);
  downloadExcel(n,r);
};

loadAll();
</script>
</body>
</html>
