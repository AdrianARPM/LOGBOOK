<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>LOGBOOK — Missing Driver</title>

<!-- ===== XLSX (Excel Export) ===== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:linear-gradient(135deg,#f0fdfa,#f8fafc);
  margin:0;
  padding:24px;
  color:#0f172a;
}
.wrap{
  max-width:1200px;
  margin:auto;
  background:#fff;
  padding:24px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(15,23,42,.08);
}
h1{margin:0 0 18px;font-size:24px;font-weight:700}
h3{margin:0 0 12px;font-size:18px;font-weight:600}
.controls{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-bottom:16px;
}
input,select{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #e2e8f0;
  background:#f8fafc;
  font-size:14px;
}
input:focus,select:focus{
  outline:none;
  border-color:#0ea5b7;
  box-shadow:0 0 0 3px rgba(14,165,183,.15);
}
button{
  padding:10px 14px;
  border-radius:10px;
  border:none;
  background:linear-gradient(135deg,#0ea5b7,#14b8a6);
  color:#fff;
  font-size:14px;
  cursor:pointer;
}
button:hover{opacity:.9}
button:disabled{opacity:.5}
.panel{
  margin-top:20px;
  padding:18px;
  border-radius:14px;
  background:#f8fafc;
  border:1px solid #e2e8f0;
}
.flexrow{
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
}
.small{font-size:13px;color:#64748b}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  margin-top:12px;
  font-size:14px;
}
th{
  background:linear-gradient(135deg,#0ea5b7,#14b8a6);
  color:#fff;
  padding:12px;
  text-align:left;
  position:sticky;
  top:0;
}
td{
  padding:10px 12px;
  border-bottom:1px solid #e2e8f0;
}
tbody tr:hover{background:#f1f5f9}
.pagination{
  margin-top:16px;
  display:flex;
  gap:10px;
  align-items:center;
}
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.badge-ok{background:#dcfce7;color:#166534}
.badge-warning{background:#fef3c7;color:#92400e}
.badge-danger{background:#fee2e2;color:#991b1b}
#status{
  margin-top:12px;
  padding:10px 12px;
  background:#f1f5f9;
  border-radius:10px;
}
</style>
</head>

<body>
<div class="wrap">

<h1>LOGBOOK — Driver Belum Mengisi</h1>

<div class="controls">
  <input id="filterCabang" placeholder="Filter cabang">
  <input id="filterPlat" placeholder="Filter plat">
  <select id="missingCabangFilter">
    <option value="">Semua cabang</option>
  </select>
  <button id="btnRefresh">Refresh</button>
</div>

<div class="panel">
<h3>Cek Missing (N Hari)</h3>
<div class="flexrow">
  <label>N hari
    <input id="missingDaysCount" type="number" value="7" style="width:80px">
  </label>
  <button id="btnMissingLastNDays">Tampilkan</button>
  <button id="btnMissingLastNDaysTable">Tulis ke Tabel</button>
  <button id="btnDownloadMissingLastNDaysCSV">CSV</button>
  <button id="btnDownloadMissingLastNDaysExcel">Excel</button>
  <label class="small">
    <input type="checkbox" id="excludeSundays2"> Exclude Sunday
  </label>
</div>
</div>

<div id="status">Memuat...</div>

<div style="overflow:auto">
<table>
<thead id="thead"></thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="pagination" id="paginationControls" style="display:none">
<button id="btnPrevPage">Prev</button>
<span>Page <input id="inputPage" type="number" value="1" style="width:60px"> / <span id="spanTotalPages">1</span></span>
<button id="btnNextPage">Next</button>
</div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxD3EsjEJ3X5PiEjDwor_YljpqUWUmYObHRKgavtUJ5TOqs4eaITa2XatvSTxtSlbXE/exec";
const API_KEY="KEY-2025";

let rawRows=[],currentKeys=[],currentPage=1;
const pageSize=50;
let driverCabangMap={};

function normalizeName(s){return String(s||'').trim().toLowerCase()}
function renderBadge(n){
  if(n==0)return'<span class="badge badge-ok">0</span>';
  if(n<=3)return'<span class="badge badge-warning">'+n+'</span>';
  return'<span class="badge badge-danger">'+n+'</span>';
}

async function fetchApi(p){
  p.apiKey=API_KEY;
  const r=await fetch(API_URL+'?'+new URLSearchParams(p));
  return r.json();
}

function renderTable(){
  const thead=document.getElementById('thead');
  const tbody=document.getElementById('tbody');
  thead.innerHTML='';tbody.innerHTML='';
  if(!rawRows.length){thead.innerHTML='<tr><th>Tidak ada data</th></tr>';return;}
  if(!currentKeys.length)currentKeys=Object.keys(rawRows[0]);
  thead.innerHTML='<tr>'+currentKeys.map(k=>'<th>'+k+'</th>').join('')+'</tr>';
  const start=(currentPage-1)*pageSize;
  rawRows.slice(start,start+pageSize).forEach(r=>{
    const tr=document.createElement('tr');
    currentKeys.forEach(k=>{
      const td=document.createElement('td');
      if(k==='Total Missing')td.innerHTML=renderBadge(Number(r[k]));
      else td.textContent=r[k];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  document.getElementById('paginationControls').style.display=rawRows.length>pageSize?'flex':'none';
  document.getElementById('spanTotalPages').textContent=Math.ceil(rawRows.length/pageSize);
}

function downloadExcel(filename,rows){
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Missing');
  XLSX.writeFile(wb,filename);
}

/* EVENTS */
document.getElementById('btnDownloadMissingLastNDaysExcel').onclick=async()=>{
  const n=+missingDaysCount.value||7;
  const res=await fetchApi({action:'missingLastNDays',n});
  const per=res.result.perDriverMissingDays||{};
  const rows=[['Driver','Total Missing','Missing Days']];
  Object.keys(per).forEach(d=>rows.push([d,per[d].length,per[d].join(', ')]));
  downloadExcel(`missing_${n}_days.xlsx`,rows);
};

loadAll();
async function loadAll(){
  const res=await fetchApi({action:'getAll'});
  rawRows=res.data||[];
  currentKeys=rawRows[0]?Object.keys(rawRows[0]):[];
  renderTable();
  status.textContent='Loaded '+rawRows.length+' rows';
}
</script>
</body>
</html>
