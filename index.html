<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>LOGBOOK — Monitoring Inspeksi & Missing Driver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body class="bg-slate-100 min-h-screen p-6">
<div class="max-w-7xl mx-auto bg-white rounded-xl shadow p-6">

<h1 class="text-2xl font-bold mb-6">
  LOGBOOK — Monitoring Inspeksi & Missing Driver
</h1>

<!-- FILTER -->
<div class="grid md:grid-cols-5 gap-3 mb-4">
  <input id="filterCabang" class="input" placeholder="Filter Cabang">
  <input id="filterPlat" class="input" placeholder="Filter Plat">
  <select id="missingCabangFilter" class="input">
    <option value="">Semua Cabang</option>
  </select>
  <input id="missingDaysCount" type="number" value="7" min="1" class="input">
  <button id="btnRefresh" class="btn-blue">Refresh</button>
</div>

<!-- ACTION -->
<div class="flex flex-wrap gap-3 mb-4 items-center">
  <label class="flex items-center gap-2 text-sm">
    <input id="excludeSundays" type="checkbox" class="scale-110">
    Exclude Hari Minggu
  </label>

  <button id="btnMissing" class="btn-orange">Cek Missing N Hari</button>
  <button id="btnExcel" class="btn-green">Download Excel</button>
  <button id="btnPDF" class="btn-red">Download PDF</button>
</div>

<p id="status" class="text-sm text-slate-500 mb-3">Memuat...</p>

<!-- TABLE -->
<div class="overflow-auto">
<table class="min-w-full text-sm border" id="tbl">
  <thead class="bg-cyan-600 text-white" id="thead"></thead>
  <tbody id="tbody"></tbody>
</table>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbxD3EsjEJ3X5PiEjDwor_YljpqUWUmYObHRKgavtUJ5TOqs4eaITa2XatvSTxtSlbXE/exec";
const API_KEY = "KEY-2025";

/* ================= STATE ================= */
let rawRows = [];
let currentKeys = [];

/* ================= FETCH ================= */
async function fetchApi(params = {}) {
  params.apiKey = API_KEY;
  const url = API_URL + "?" + new URLSearchParams(params);
  const res = await fetch(url);
  return await res.json();
}

/* ================= LOAD ALL ================= */
async function loadAll() {
  document.getElementById("status").textContent = "Memuat...";
  const res = await fetchApi({ action: "getAll" });
  rawRows = res.data || [];
  currentKeys = rawRows[0] ? Object.keys(rawRows[0]) : [];
  renderTable(rawRows);
  document.getElementById("status").textContent =
    `Selesai. ${rawRows.length} baris`;
}

/* ================= TABLE ================= */
function renderTable(rows) {
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  thead.innerHTML = tbody.innerHTML = "";

  if (!rows.length) {
    thead.innerHTML = "<tr><th>Tidak ada data</th></tr>";
    return;
  }

  thead.innerHTML =
    "<tr>" + currentKeys.map(k => `<th class="px-2 py-2">${k}</th>`).join("") + "</tr>";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = currentKeys.map(k =>
      `<td class="border px-2 py-1">${r[k] ?? ""}</td>`
    ).join("");
    tbody.appendChild(tr);
  });
}

/* ================= MISSING ================= */
document.getElementById("btnMissing").onclick = async () => {
  const n = Number(document.getElementById("missingDaysCount").value || 7);
  const exclude = document.getElementById("excludeSundays").checked;

  const res = await fetchApi({
    action: "missingLastNDays",
    n,
    excludeSundays: exclude ? "true" : "false"
  });

  const per = res.result?.perDriverMissingDays || {};
  const rows = Object.keys(per).map(d => ({
    Driver: d,
    "Total Missing": per[d].length,
    "Tanggal Kosong": per[d].join(", ")
  }));

  rawRows = rows;
  currentKeys = ["Driver", "Total Missing", "Tanggal Kosong"];
  renderTable(rawRows);
};

/* ================= EXCEL ================= */
document.getElementById("btnExcel").onclick = () => {
  const ws = XLSX.utils.json_to_sheet(rawRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Missing");
  XLSX.writeFile(wb, "missing_driver.xlsx");
};

/* ================= PDF ================= */
document.getElementById("btnPDF").onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("l", "pt", "a4");
  doc.text("Missing Driver Logbook", 40, 40);
  doc.autoTable({
    startY: 60,
    head: [currentKeys],
    body: rawRows.map(r => currentKeys.map(k => r[k])),
  });
  doc.save("missing_driver.pdf");
};

/* ================= INIT ================= */
loadAll();
</script>

<style>
.input{ @apply border rounded px-3 py-2 w-full }
.btn-blue{ @apply bg-blue-600 text-white px-4 py-2 rounded }
.btn-orange{ @apply bg-orange-500 text-white px-4 py-2 rounded }
.btn-green{ @apply bg-green-600 text-white px-4 py-2 rounded }
.btn-red{ @apply bg-red-600 text-white px-4 py-2 rounded }
</style>
</body>
</html>
